<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breaking Ground Schools | Spring Survey Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Dark navy gradient foundation */
            --bg-primary: #012141;
            --bg-card: #FFFFFF;
            --bg-card-hover: #FAFCFF;
            --bg-muted: #F0F6F9;

            /* Dodger blue for accents/text */
            --text-primary: #012141;
            --text-secondary: #012141;
            --text-muted: #1A4A6E;
            --text-on-dark: #FFFFFF;
            --accent-blue: #28AAE1;

            /* Brand colors */
            --accent-primary: #28AAE1;
            --accent-gold: #D4A012;
            --accent-gold-light: #F5C842;
            --accent-glow: rgba(40, 170, 225, 0.2);

            /* Gold borders */
            --border: #D4A012;
            --border-light: #E8C547;
            --border-subtle: rgba(40, 170, 225, 0.3);

            /* Survey response colors */
            --strongly-agree: #0D9488;
            --agree: #2DD4BF;
            --disagree: #F59E0B;
            --strongly-disagree: #E11D48;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(1, 33, 65, 0.1);
            --shadow-md: 0 8px 30px rgba(1, 33, 65, 0.15);
            --shadow-lg: 0 20px 50px rgba(1, 33, 65, 0.2);

            /* Alert colors */
            --alert-warning: #DC2626;
            --alert-warning-bg: rgba(220, 38, 38, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, #012141 0%, #023E73 50%, #01304D 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Dark navy gradient background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #012141 0%, #023E73 50%, #01304D 100%);
            pointer-events: none;
            z-index: -1;
        }

        header {
            padding: 1.25rem 2rem;
            border-bottom: 1px solid rgba(40, 170, 225, 0.3);
            background: rgba(1, 33, 65, 0.95);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .brand:hover {
            opacity: 0.9;
        }

        .brand-icon {
            width: 38px;
            height: 38px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .brand-icon svg {
            width: 20px;
            height: 20px;
            fill: #28AAE1;
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-weight: 600;
            font-size: 1.2rem;
            letter-spacing: -0.01em;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #28AAE1;
            border-radius: 50%;
            animation: blink 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(40, 170, 225, 0.6);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .last-updated {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.75);
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* HOME VIEW */
        .home-view {
            display: block;
        }

        .home-view.hidden {
            display: none;
        }

        .page-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.9rem;
            margin-bottom: 0.4rem;
            letter-spacing: -0.02em;
            color: white;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            margin-bottom: 2.25rem;
        }

        .survey-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .survey-card {
            background: var(--bg-card);
            border: 2px solid rgba(40, 170, 225, 0.4);
            border-radius: 20px;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .survey-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #28AAE1, #5BC0EB);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .survey-card:hover {
            background: var(--bg-card);
            border-color: #28AAE1;
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(40, 170, 225, 0.3);
        }

        .survey-card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .card-title-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(10, 22, 40, 0.08), rgba(10, 22, 40, 0.04));
            border: 1px solid rgba(212, 160, 18, 0.3);
        }

        .card-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--text-primary);
        }

        .card-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.2rem;
        }

        .card-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .card-badge.in-progress {
            background: rgba(212, 160, 18, 0.15);
            color: #B8860B;
        }

        .card-badge.goal-met {
            background: rgba(13, 148, 136, 0.15);
            color: var(--strongly-agree);
        }

        .metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric {
            background: var(--bg-muted);
            border-radius: 12px;
            padding: 1.1rem;
            border: 1px solid rgba(212, 160, 18, 0.25);
        }

        .metric-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 0.4rem;
        }

        .metric-value {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            letter-spacing: -0.03em;
            color: #28AAE1;
        }

        .progress-section {
            margin-top: 0.5rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .progress-percentage {
            font-family: 'Fraunces', serif;
            font-weight: 600;
            font-size: 0.95rem;
            color: #28AAE1;
        }

        .progress-bar-bg {
            height: 8px;
            background: var(--bg-muted);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #28AAE1, #5BC0EB);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: shimmer 2.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .goal-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .view-details {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-subtle);
            font-size: 0.8rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .view-details svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            transition: transform 0.2s;
        }

        .survey-card:hover .view-details svg {
            transform: translateX(4px);
        }

        /* DETAIL VIEW */
        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: color 0.2s;
            background: none;
            border: none;
            font-family: inherit;
        }

        .back-button:hover {
            color: white;
        }

        .back-button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .detail-title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .detail-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #28AAE1;
            box-shadow: var(--shadow-sm);
        }

        .detail-icon svg {
            width: 30px;
            height: 30px;
            fill: var(--text-primary);
        }

        .detail-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.5rem;
            color: white;
        }

        .detail-subtitle {
            color: rgba(255, 255, 255, 0.75);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .detail-stats {
            display: flex;
            gap: 2rem;
            text-align: right;
        }

        .detail-stat-value {
            font-family: 'Fraunces', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: #28AAE1;
        }

        .detail-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.7);
        }

        .detail-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .chart-panel {
            background: var(--bg-card);
            border: 2px solid rgba(40, 170, 225, 0.5);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
        }

        .panel-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.05rem;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
        }

        .chart-wrapper {
            height: 320px;
        }

        .insights-panel {
            background: var(--bg-card);
            border: 2px solid rgba(40, 170, 225, 0.5);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
        }

        .insight-card {
            background: var(--bg-muted);
            border-radius: 12px;
            padding: 1.1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(40, 170, 225, 0.2);
            transition: all 0.25s ease;
            cursor: default;
        }

        .insight-card:hover {
            border-color: #28AAE1;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(40, 170, 225, 0.15);
            background: #FFFFFF;
        }

        .insight-card:last-child {
            margin-bottom: 0;
        }

        .insight-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .insight-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .insight-value {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .insight-value.positive {
            color: var(--strongly-agree);
        }

        .insight-value.negative {
            color: var(--strongly-disagree);
        }

        .feedback-section {
            margin-top: 1rem;
        }

        .feedback-item {
            background: var(--bg-muted);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--accent-gold);
            transition: transform 0.2s;
        }

        .feedback-item:hover {
            transform: translateX(2px);
        }

        .feedback-item.positive {
            border-left-color: var(--strongly-agree);
            background: linear-gradient(90deg, rgba(13, 148, 136, 0.08), var(--bg-muted));
        }

        .feedback-item.concern {
            border-left-color: var(--disagree);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), var(--bg-muted));
        }

        .feedback-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
            line-height: 1.55;
        }

        /* Satisfaction Score */
        .satisfaction-score {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: linear-gradient(135deg, var(--bg-muted), #E8F4F8);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(212, 160, 18, 0.2);
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Fraunces', serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .score-circle.high {
            background: linear-gradient(135deg, var(--strongly-agree), #10B981);
        }

        .score-circle.medium {
            background: linear-gradient(135deg, var(--disagree), #FBBF24);
        }

        .score-circle.low {
            background: linear-gradient(135deg, var(--strongly-disagree), #F87171);
        }

        .score-details {
            flex: 1;
        }

        .score-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .score-description {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-top: 0.2rem;
        }

        /* Concern Alert */
        .concern-alert {
            background: var(--alert-warning-bg);
            border: 1px solid var(--alert-warning);
            border-radius: 10px;
            padding: 0.85rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .concern-alert-icon {
            width: 20px;
            height: 20px;
            fill: var(--alert-warning);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .concern-alert-content {
            flex: 1;
        }

        .concern-alert-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--alert-warning);
            margin-bottom: 0.2rem;
        }

        .concern-alert-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Goal Met Celebration */
        .goal-met-banner {
            background: linear-gradient(135deg, var(--strongly-agree), #10B981);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 1rem;
            animation: celebratePulse 2s ease-in-out infinite;
        }

        @keyframes celebratePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Trend Chart Container */
        .trend-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-subtle);
        }

        .trend-chart-wrapper {
            height: 120px;
            margin-top: 0.75rem;
        }

        .feedback-type {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 1.25rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-dot.sa { background: var(--strongly-agree); }
        .legend-dot.a { background: var(--agree); }
        .legend-dot.d { background: var(--disagree); }
        .legend-dot.sd { background: var(--strongly-disagree); }

        /* Tabs */
        .chart-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-subtle);
            padding-bottom: 0.5rem;
        }

        .chart-tab {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
            background: none;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .chart-tab:hover {
            color: var(--text-primary);
            background: var(--bg-muted);
        }

        .chart-tab.active {
            color: var(--text-primary);
            background: var(--accent-gold);
            color: white;
        }

        .chart-tab-content {
            display: none;
        }

        .chart-tab-content.active {
            display: block;
        }

        /* Question selector */
        .question-selector {
            margin-bottom: 1rem;
        }

        .question-select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            font-family: inherit;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-muted);
            color: var(--text-primary);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .question-select:hover, .question-select:focus {
            border-color: var(--accent-gold);
            outline: none;
        }

        /* Single question chart */
        .single-question-chart {
            height: 200px;
            margin-bottom: 1rem;
        }

        .question-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .question-stat {
            text-align: center;
            padding: 0.75rem;
            border-radius: 10px;
            background: var(--bg-muted);
        }

        .question-stat-value {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .question-stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .question-stat.sa .question-stat-value { color: var(--strongly-agree); }
        .question-stat.a .question-stat-value { color: var(--agree); }
        .question-stat.d .question-stat-value { color: var(--disagree); }
        .question-stat.sd .question-stat-value { color: var(--strongly-disagree); }

        /* Download buttons */
        .chart-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
        }

        .chart-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.85rem;
            font-size: 0.75rem;
            font-weight: 500;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-action-btn:hover {
            background: var(--accent-gold);
            color: white;
            border-color: var(--accent-gold);
        }

        .chart-action-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* Key Insight Banner */
        .insight-banner {
            background: linear-gradient(135deg, #012141 0%, #023E73 100%);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(212, 160, 18, 0.3);
        }

        .insight-banner-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .insight-banner-icon svg {
            width: 24px;
            height: 24px;
            fill: #012141;
        }

        .insight-banner-content {
            flex: 1;
        }

        .insight-banner-headline {
            font-family: 'Fraunces', serif;
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
            margin-bottom: 0.25rem;
        }

        .insight-banner-detail {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.75);
        }

        .insight-banner-stat {
            text-align: right;
            padding-left: 1.5rem;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
        }

        .insight-banner-stat-value {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-gold);
            line-height: 1;
        }

        .insight-banner-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.25rem;
        }

        /* Response Velocity */
        .velocity-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.7rem;
            background: rgba(13, 148, 136, 0.15);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--strongly-agree);
            margin-top: 0.5rem;
        }

        .velocity-badge.slow {
            background: rgba(245, 158, 11, 0.15);
            color: var(--disagree);
        }

        .velocity-badge svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* Presentation Mode */
        .presentation-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .presentation-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .presentation-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* Presentation Mode Active */
        body.presentation-mode {
            background: #012141;
        }

        body.presentation-mode .bg-gradient {
            background: #012141;
        }

        body.presentation-mode header {
            display: none;
        }

        body.presentation-mode .home-view {
            padding-top: 2rem;
        }

        body.presentation-mode .page-title {
            font-size: 2.5rem;
            text-align: center;
        }

        body.presentation-mode .page-subtitle {
            text-align: center;
            font-size: 1.1rem;
        }

        body.presentation-mode .insight-banner {
            max-width: 900px;
            margin: 0 auto 2rem auto;
        }

        body.presentation-mode .survey-cards {
            max-width: 1200px;
            margin: 0 auto;
        }

        body.presentation-mode .survey-card {
            transform: scale(1.02);
        }

        body.presentation-mode .exit-presentation {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
        }

        .exit-presentation {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .exit-presentation:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        @media (max-width: 1000px) {
            .survey-cards {
                grid-template-columns: 1fr;
            }

            .detail-content {
                grid-template-columns: 1fr;
            }

            .detail-header {
                flex-direction: column;
                gap: 1rem;
            }

            .detail-stats {
                text-align: left;
            }
        }

        @media (max-width: 600px) {
            header {
                padding: 1rem;
            }

            main {
                padding: 1rem;
            }

            .metrics-row {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 1.5rem;
            }
        }

        /* AI Chat Panel Styles */
        .chat-panel {
            background: var(--bg-card);
            border: 2px solid rgba(40, 170, 225, 0.5);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--bg-muted);
        }

        .chat-header-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), #5BC0EB);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-header-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .chat-header-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-message {
            padding: 0.875rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            max-width: 95%;
        }

        .chat-message.user {
            background: linear-gradient(135deg, var(--accent-primary), #5BC0EB);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant {
            background: var(--bg-muted);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-message.assistant p {
            margin: 0 0 0.5rem 0;
        }

        .chat-message.assistant p:last-child {
            margin-bottom: 0;
        }

        .chat-message.assistant ul, .chat-message.assistant ol {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }

        .chat-message.assistant li {
            margin-bottom: 0.25rem;
        }

        .chat-message.loading {
            background: var(--bg-muted);
            color: var(--text-muted);
        }

        .chat-message.loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chat-suggestion {
            padding: 0.5rem 0.875rem;
            background: var(--bg-muted);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-suggestion:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 2px solid var(--bg-muted);
            border-radius: 12px;
            font-size: 0.9rem;
            font-family: inherit;
            background: var(--bg-muted);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: white;
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-send-btn {
            padding: 0.875rem 1.25rem;
            background: linear-gradient(135deg, var(--accent-primary), #5BC0EB);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 170, 225, 0.4);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <header>
        <div class="header-content">
            <div class="brand" onclick="showHome()">
                <div class="brand-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <h1>Breaking Ground Schools Spring Survey Dashboard</h1>
            </div>
            <div class="status-bar">
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    Live
                </div>
                <span class="last-updated" id="lastUpdated">Updating...</span>
                <button class="presentation-btn" onclick="togglePresentationMode()">
                    <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/></svg>
                    Present
                </button>
            </div>
        </div>
    </header>

    <button class="exit-presentation" onclick="togglePresentationMode()">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        Exit Presentation
    </button>

    <main>
        <!-- HOME VIEW -->
        <div class="home-view" id="homeView">
            <h2 class="page-title">School Climate Surveys</h2>
            <p class="page-subtitle">Real-time response tracking and insights</p>

            <div class="survey-cards">
                <!-- Family Survey Card -->
                <div class="survey-card" onclick="showDetail('family')">
                    <div class="card-header">
                        <div class="card-title-section">
                            <div class="card-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                                </svg>
                            </div>
                            <span class="card-title">Family Survey</span>
                        </div>
                        <span class="card-badge in-progress" id="familyBadge">In Progress</span>
                    </div>

                    <div class="metrics-row">
                        <div class="metric">
                            <div class="metric-label">Total Responses</div>
                            <div class="metric-value" id="familyCount">—</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Completion</div>
                            <div class="metric-value" id="familyRate">—</div>
                        </div>
                    </div>

                    <div class="satisfaction-score" id="familySatisfactionCard">
                        <div class="score-circle high" id="familyScoreCircle">—</div>
                        <div class="score-details">
                            <div class="score-label">Satisfaction Score</div>
                            <div class="score-description" id="familyScoreDesc">Calculating...</div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Progress to Goal</span>
                            <span class="progress-percentage" id="familyPercent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="familyProgress" style="width: 0%"></div>
                        </div>
                        <p class="goal-text"><span id="familyGoalText">0</span> of <strong>1,000</strong> goal</p>
                    </div>

                    <div class="view-details">
                        View Details & Insights
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>

                <!-- Faculty Survey Card -->
                <div class="survey-card" onclick="showDetail('faculty')">
                    <div class="card-header">
                        <div class="card-title-section">
                            <div class="card-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                                </svg>
                            </div>
                            <span class="card-title">Faculty Survey</span>
                        </div>
                        <span class="card-badge in-progress" id="facultyBadge">In Progress</span>
                    </div>

                    <div class="metrics-row">
                        <div class="metric">
                            <div class="metric-label">Total Responses</div>
                            <div class="metric-value" id="facultyCount">—</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Completion</div>
                            <div class="metric-value" id="facultyRate">—</div>
                        </div>
                    </div>

                    <div class="satisfaction-score" id="facultySatisfactionCard">
                        <div class="score-circle high" id="facultyScoreCircle">—</div>
                        <div class="score-details">
                            <div class="score-label">Satisfaction Score</div>
                            <div class="score-description" id="facultyScoreDesc">Calculating...</div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Progress to Goal</span>
                            <span class="progress-percentage" id="facultyPercent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="facultyProgress" style="width: 0%"></div>
                        </div>
                        <p class="goal-text"><span id="facultyGoalText">0</span> of <strong>85</strong> goal</p>
                    </div>

                    <div class="view-details">
                        View Details & Insights
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAMILY DETAIL VIEW -->
        <div class="detail-view" id="familyDetail">
            <button class="back-button" onclick="showHome()">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                Back to Overview
            </button>

            <div class="detail-header">
                <div class="detail-title-section">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="detail-title">Family Survey</h2>
                        <p class="detail-subtitle">13 questions · School climate & satisfaction</p>
                    </div>
                </div>
                <div class="detail-stats">
                    <div>
                        <div class="detail-stat-value" id="familyDetailCount">—</div>
                        <div class="detail-stat-label">Responses</div>
                    </div>
                    <div>
                        <div class="detail-stat-value" id="familyDetailPercent">—</div>
                        <div class="detail-stat-label">To Goal</div>
                    </div>
                </div>
            </div>

            <div class="detail-content">
                <div class="chart-panel">
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="switchFamilyTab('overview')">All Questions</button>
                        <button class="chart-tab" onclick="switchFamilyTab('single')">By Question</button>
                    </div>

                    <!-- Overview Tab -->
                    <div class="chart-tab-content active" id="familyOverviewTab">
                        <div class="chart-wrapper">
                            <canvas id="familyChart"></canvas>
                        </div>
                        <div class="legend">
                            <div class="legend-item"><div class="legend-dot sa"></div> Strongly Agree</div>
                            <div class="legend-item"><div class="legend-dot a"></div> Agree</div>
                            <div class="legend-item"><div class="legend-dot d"></div> Disagree</div>
                            <div class="legend-item"><div class="legend-dot sd"></div> Strongly Disagree</div>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn" onclick="copyChartToClipboard('familyChart')">
                                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>

                    <!-- Single Question Tab -->
                    <div class="chart-tab-content" id="familySingleTab">
                        <div class="question-selector">
                            <select class="question-select" id="familyQuestionSelect" onchange="updateFamilySingleChart()">
                            </select>
                        </div>
                        <div class="single-question-chart">
                            <canvas id="familySingleChart"></canvas>
                        </div>
                        <div class="question-stats" id="familyQuestionStats">
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn" onclick="copyChartToClipboard('familySingleChart')">
                                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>
                </div>

                <div class="insights-panel">
                    <h3 class="panel-title">Emerging Insights</h3>

                    <div id="familyConcernAlerts">
                        <!-- Concern alerts populated by JS -->
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Strongest Area</div>
                        <div class="insight-title" id="familyStrongest">Loading...</div>
                        <div class="insight-value positive" id="familyStrongestValue">—</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Area for Growth</div>
                        <div class="insight-title" id="familyWeakest">Loading...</div>
                        <div class="insight-value negative" id="familyWeakestValue">—</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Overall Sentiment</div>
                        <div class="insight-title" id="familySentiment">Loading...</div>
                        <div class="insight-value" id="familySentimentValue">—</div>
                    </div>

                    <div class="feedback-section">
                        <div class="insight-label">Family Feedback</div>
                        <div id="familyFeedback">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- AI Chat Panel -->
                <div class="chat-panel">
                    <div class="chat-header">
                        <div class="chat-header-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                        </div>
                        <span class="chat-header-title">Ask Claude</span>
                    </div>
                    <div class="chat-messages" id="familyChatMessages">
                        <div class="chat-message assistant">
                            Hi! I can help you analyze the family survey data. Try asking me about trends, concerns, or specific questions.
                        </div>
                    </div>
                    <div class="chat-suggestions" id="familyChatSuggestions">
                        <button class="chat-suggestion" onclick="askSuggestion('family', 'What are the main concerns?')">Main concerns?</button>
                        <button class="chat-suggestion" onclick="askSuggestion('family', 'Which question has the lowest satisfaction?')">Lowest satisfaction?</button>
                        <button class="chat-suggestion" onclick="askSuggestion('family', 'Summarize the feedback')">Summarize feedback</button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="familyChatInput" placeholder="Ask about the survey data..." onkeypress="handleChatKeypress(event, 'family')">
                        <button class="chat-send-btn" onclick="sendChatMessage('family')" id="familySendBtn">
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FACULTY DETAIL VIEW -->
        <div class="detail-view" id="facultyDetail">
            <button class="back-button" onclick="showHome()">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                Back to Overview
            </button>

            <div class="detail-header">
                <div class="detail-title-section">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="detail-title">Faculty Survey</h2>
                        <p class="detail-subtitle">5 rated questions + open feedback</p>
                    </div>
                </div>
                <div class="detail-stats">
                    <div>
                        <div class="detail-stat-value" id="facultyDetailCount">—</div>
                        <div class="detail-stat-label">Responses</div>
                    </div>
                    <div>
                        <div class="detail-stat-value" id="facultyDetailPercent">—</div>
                        <div class="detail-stat-label">To Goal</div>
                    </div>
                </div>
            </div>

            <div class="detail-content">
                <div class="chart-panel">
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="switchFacultyTab('overview')">All Questions</button>
                        <button class="chart-tab" onclick="switchFacultyTab('single')">By Question</button>
                    </div>

                    <!-- Overview Tab -->
                    <div class="chart-tab-content active" id="facultyOverviewTab">
                        <div class="chart-wrapper">
                            <canvas id="facultyChart"></canvas>
                        </div>
                        <div class="legend">
                            <div class="legend-item"><div class="legend-dot sa"></div> Strongly Agree</div>
                            <div class="legend-item"><div class="legend-dot a"></div> Agree</div>
                            <div class="legend-item"><div class="legend-dot d"></div> Disagree</div>
                            <div class="legend-item"><div class="legend-dot sd"></div> Strongly Disagree</div>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn" onclick="copyChartToClipboard('facultyChart')">
                                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                Copy to Clipboard
                            </button>
                        </div>

                        <div class="trend-section">
                            <h4 class="panel-title" style="margin-bottom: 0.5rem; font-size: 0.95rem;">Response Timeline</h4>
                            <div class="trend-chart-wrapper">
                                <canvas id="facultyTimelineChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Single Question Tab -->
                    <div class="chart-tab-content" id="facultySingleTab">
                        <div class="question-selector">
                            <select class="question-select" id="facultyQuestionSelect" onchange="updateFacultySingleChart()">
                            </select>
                        </div>
                        <div class="single-question-chart">
                            <canvas id="facultySingleChart"></canvas>
                        </div>
                        <div class="question-stats" id="facultyQuestionStats">
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn" onclick="copyChartToClipboard('facultySingleChart')">
                                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>
                </div>

                <div class="insights-panel">
                    <h3 class="panel-title">Emerging Insights</h3>

                    <div id="facultyConcernAlerts">
                        <!-- Concern alerts populated by JS -->
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Strongest Area</div>
                        <div class="insight-title" id="facultyStrongest">Loading...</div>
                        <div class="insight-value positive" id="facultyStrongestValue">—</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Area for Growth</div>
                        <div class="insight-title" id="facultyWeakest">Loading...</div>
                        <div class="insight-value negative" id="facultyWeakestValue">—</div>
                    </div>

                    <div class="feedback-section">
                        <div class="insight-label">Recent Feedback</div>
                        <div id="facultyFeedback">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- AI Chat Panel -->
                <div class="chat-panel">
                    <div class="chat-header">
                        <div class="chat-header-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                        </div>
                        <span class="chat-header-title">Ask Claude</span>
                    </div>
                    <div class="chat-messages" id="facultyChatMessages">
                        <div class="chat-message assistant">
                            Hi! I can help you analyze the faculty survey data. Ask me about satisfaction trends, concerns, or feedback themes.
                        </div>
                    </div>
                    <div class="chat-suggestions" id="facultyChatSuggestions">
                        <button class="chat-suggestion" onclick="askSuggestion('faculty', 'What are the top concerns?')">Top concerns?</button>
                        <button class="chat-suggestion" onclick="askSuggestion('faculty', 'How is team communication rated?')">Communication rating?</button>
                        <button class="chat-suggestion" onclick="askSuggestion('faculty', 'Summarize the positive feedback')">Positive feedback</button>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="facultyChatInput" placeholder="Ask about the survey data..." onkeypress="handleChatKeypress(event, 'faculty')">
                        <button class="chat-send-btn" onclick="sendChatMessage('faculty')" id="facultySendBtn">
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const CONFIG = {
            familyCSVUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8pRoz4n4UvsQTCtGZnGuVle3OfuFDsldtKPKpHTapaoKnk8glLNolfPclWgeL512OrHb4HD0eDw40/pub?output=csv',
            familyGoal: 1000,
            facultyGoal: 85,
            refreshInterval: 30000
        };

        const COLORS = {
            stronglyAgree: '#0D9488',
            agree: '#2DD4BF',
            disagree: '#F59E0B',
            stronglyDisagree: '#E11D48'
        };

        const FAMILY_QUESTIONS = [
            'Safe at school',
            'Welcomed & respected',
            'Teachers care',
            'Appropriately challenged',
            'Clear communication',
            'Comfortable reaching out',
            'Social-emotional support',
            'Values DEI',
            'Enjoys school',
            'Overall satisfaction',
            'Responds to feedback',
            'Informed on progress',
            'Would recommend'
        ];

        const FAMILY_QUESTIONS_FULL = [
            'My child feels safe at school',
            'My child feels welcomed and respected',
            'Teachers care about my child\'s learning',
            'My child is challenged appropriately',
            'School communicates clearly with families',
            'I feel comfortable reaching out to teachers',
            'School supports social/emotional development',
            'School values diversity, equity, inclusion',
            'My child enjoys coming to school',
            'Overall satisfaction',
            'School responds to family feedback',
            'I feel informed about academic progress',
            'I would recommend this school'
        ];

        const FACULTY_QUESTIONS = [
            'Org culture',
            'Team mission',
            'Feedback',
            'Communication',
            'Ideas valued'
        ];

        const FACULTY_QUESTIONS_FULL = [
            'Satisfied with organizational culture',
            'Team connected to mission',
            'Receive constructive feedback',
            'Team communication is effective',
            'Ideas and input are valued'
        ];

        let familyChart, facultyChart, facultyTimelineChart;
        let familySingleChart, facultySingleChart;
        let familyData = { distribution: [], count: 0, feedback: [] };
        let facultyData = { distribution: [], count: 0, feedback: [], timeline: [] };

        // Tab switching
        function switchFamilyTab(tab) {
            const tabs = document.querySelectorAll('#familyDetail .chart-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('familyOverviewTab').classList.remove('active');
            document.getElementById('familySingleTab').classList.remove('active');

            if (tab === 'overview') {
                document.getElementById('familyOverviewTab').classList.add('active');
            } else {
                document.getElementById('familySingleTab').classList.add('active');
                populateFamilyQuestionSelect();
                if (!familySingleChart) createFamilySingleChart();
                updateFamilySingleChart();
            }
        }

        function switchFacultyTab(tab) {
            const tabs = document.querySelectorAll('#facultyDetail .chart-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('facultyOverviewTab').classList.remove('active');
            document.getElementById('facultySingleTab').classList.remove('active');

            if (tab === 'overview') {
                document.getElementById('facultyOverviewTab').classList.add('active');
            } else {
                document.getElementById('facultySingleTab').classList.add('active');
                populateFacultyQuestionSelect();
                if (!facultySingleChart) createFacultySingleChart();
                updateFacultySingleChart();
            }
        }

        // Populate question selectors
        function populateFamilyQuestionSelect() {
            const select = document.getElementById('familyQuestionSelect');
            if (select.options.length === 0) {
                FAMILY_QUESTIONS_FULL.forEach((q, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = q;
                    select.appendChild(option);
                });
            }
        }

        function populateFacultyQuestionSelect() {
            const select = document.getElementById('facultyQuestionSelect');
            if (select.options.length === 0) {
                FACULTY_QUESTIONS_FULL.forEach((q, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = q;
                    select.appendChild(option);
                });
            }
        }

        // Create single question charts
        function createFamilySingleChart() {
            const ctx = document.getElementById('familySingleChart').getContext('2d');
            familySingleChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Strongly Agree', 'Agree', 'Disagree', 'Strongly Disagree'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [COLORS.stronglyAgree, COLORS.agree, COLORS.disagree, COLORS.stronglyDisagree],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#012141',
                            titleFont: { family: 'DM Sans', size: 12 },
                            bodyFont: { family: 'DM Sans', size: 11 },
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function createFacultySingleChart() {
            const ctx = document.getElementById('facultySingleChart').getContext('2d');
            facultySingleChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Strongly Agree', 'Agree', 'Disagree', 'Strongly Disagree'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [COLORS.stronglyAgree, COLORS.agree, COLORS.disagree, COLORS.stronglyDisagree],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#012141',
                            titleFont: { family: 'DM Sans', size: 12 },
                            bodyFont: { family: 'DM Sans', size: 11 },
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Update single question charts
        function updateFamilySingleChart() {
            const select = document.getElementById('familyQuestionSelect');
            const index = parseInt(select.value) || 0;

            if (!familyData.distribution[index] || !familySingleChart) return;

            const dist = familyData.distribution[index];
            const sa = dist['Strongly Agree'] || 0;
            const a = dist['Agree'] || 0;
            const d = dist['Disagree'] || 0;
            const sd = dist['Strongly Disagree'] || 0;
            const total = sa + a + d + sd;

            familySingleChart.data.datasets[0].data = [sa, a, d, sd];
            familySingleChart.update('none');

            // Update stats
            document.getElementById('familyQuestionStats').innerHTML = `
                <div class="question-stat sa">
                    <div class="question-stat-value">${sa}</div>
                    <div class="question-stat-label">Strongly Agree</div>
                </div>
                <div class="question-stat a">
                    <div class="question-stat-value">${a}</div>
                    <div class="question-stat-label">Agree</div>
                </div>
                <div class="question-stat d">
                    <div class="question-stat-value">${d}</div>
                    <div class="question-stat-label">Disagree</div>
                </div>
                <div class="question-stat sd">
                    <div class="question-stat-value">${sd}</div>
                    <div class="question-stat-label">Strongly Disagree</div>
                </div>
            `;
        }

        function updateFacultySingleChart() {
            const select = document.getElementById('facultyQuestionSelect');
            const index = parseInt(select.value) || 0;

            if (!facultyData.distribution[index] || !facultySingleChart) return;

            const dist = facultyData.distribution[index];
            const sa = dist['Strongly Agree'] || 0;
            const a = dist['Agree'] || 0;
            const d = dist['Disagree'] || 0;
            const sd = dist['Strongly Disagree'] || 0;

            facultySingleChart.data.datasets[0].data = [sa, a, d, sd];
            facultySingleChart.update('none');

            // Update stats
            document.getElementById('facultyQuestionStats').innerHTML = `
                <div class="question-stat sa">
                    <div class="question-stat-value">${sa}</div>
                    <div class="question-stat-label">Strongly Agree</div>
                </div>
                <div class="question-stat a">
                    <div class="question-stat-value">${a}</div>
                    <div class="question-stat-label">Agree</div>
                </div>
                <div class="question-stat d">
                    <div class="question-stat-value">${d}</div>
                    <div class="question-stat-label">Disagree</div>
                </div>
                <div class="question-stat sd">
                    <div class="question-stat-value">${sd}</div>
                    <div class="question-stat-label">Strongly Disagree</div>
                </div>
            `;
        }

        // Create composite image with question, chart, and stats
        function createCompositeImage(chartId, surveyType) {
            return new Promise((resolve) => {
                const chartCanvas = document.getElementById(chartId);
                const isOverview = chartId.includes('Chart') && !chartId.includes('Single') && !chartId.includes('Timeline');
                const isSingle = chartId.includes('Single');

                // Create composite canvas
                const composite = document.createElement('canvas');
                const ctx = composite.getContext('2d');

                // Set dimensions
                const padding = 40;
                const width = isSingle ? 500 : Math.max(chartCanvas.width, 600) + padding * 2;
                let height = padding * 2;

                // Get question text for single view
                let questionText = '';
                let stats = null;

                if (isSingle) {
                    const selectId = surveyType === 'family' ? 'familyQuestionSelect' : 'facultyQuestionSelect';
                    const select = document.getElementById(selectId);
                    const questions = surveyType === 'family' ? FAMILY_QUESTIONS_FULL : FACULTY_QUESTIONS_FULL;
                    questionText = questions[select.value] || '';

                    const dist = surveyType === 'family'
                        ? familyData.distribution[select.value]
                        : facultyData.distribution[select.value];
                    if (dist) {
                        stats = {
                            sa: dist['Strongly Agree'] || 0,
                            a: dist['Agree'] || 0,
                            d: dist['Disagree'] || 0,
                            sd: dist['Strongly Disagree'] || 0
                        };
                    }
                    height = 450;
                } else {
                    height = chartCanvas.height + padding * 2 + 60;
                }

                composite.width = width;
                composite.height = height;

                // White background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, width, height);

                // Title
                ctx.fillStyle = '#012141';
                ctx.font = 'bold 18px DM Sans, sans-serif';
                const title = isSingle ? questionText : (surveyType === 'family' ? 'Family Survey Results' : 'Faculty Survey Results');
                ctx.fillText(title, padding, padding + 20);

                // Draw chart
                const chartY = padding + 50;
                if (isSingle) {
                    // Center the doughnut chart - maintain aspect ratio
                    const srcWidth = chartCanvas.width;
                    const srcHeight = chartCanvas.height;
                    const maxSize = 200;

                    // Use the smaller dimension to keep it as a circle
                    const scale = maxSize / Math.min(srcWidth, srcHeight);
                    const drawWidth = srcWidth * scale;
                    const drawHeight = srcHeight * scale;
                    const chartX = (width - drawWidth) / 2;

                    ctx.drawImage(chartCanvas, chartX, chartY, drawWidth, drawHeight);

                    // Draw stats below
                    if (stats) {
                        const statsY = chartY + drawHeight + 40;
                        const statWidth = 100;
                        const startX = (width - statWidth * 4) / 2;

                        const statItems = [
                            { label: 'Strongly Agree', value: stats.sa, color: '#0D9488' },
                            { label: 'Agree', value: stats.a, color: '#2DD4BF' },
                            { label: 'Disagree', value: stats.d, color: '#F59E0B' },
                            { label: 'Strongly Disagree', value: stats.sd, color: '#E11D48' }
                        ];

                        statItems.forEach((stat, i) => {
                            const x = startX + i * statWidth + statWidth / 2;

                            ctx.fillStyle = stat.color;
                            ctx.font = 'bold 28px Fraunces, serif';
                            ctx.textAlign = 'center';
                            ctx.fillText(stat.value.toString(), x, statsY);

                            ctx.fillStyle = '#1A4A6E';
                            ctx.font = '10px DM Sans, sans-serif';
                            ctx.fillText(stat.label, x, statsY + 18);
                        });
                        ctx.textAlign = 'left';
                    }
                } else {
                    ctx.drawImage(chartCanvas, padding, chartY);
                }

                // Footer
                ctx.fillStyle = '#1A4A6E';
                ctx.font = '11px DM Sans, sans-serif';
                ctx.fillText(`Generated ${new Date().toLocaleDateString()}`, padding, height - 15);

                composite.toBlob(resolve, 'image/png');
            });
        }

        // Download chart as PNG
        async function downloadChart(chartId, filename) {
            const surveyType = chartId.includes('family') ? 'family' : 'faculty';
            const blob = await createCompositeImage(chartId, surveyType);

            const link = document.createElement('a');
            link.download = `${filename}-${new Date().toISOString().split('T')[0]}.png`;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // Copy chart to clipboard
        async function copyChartToClipboard(chartId) {
            const btn = event.target.closest('.chart-action-btn');
            const originalText = btn.innerHTML;

            try {
                const surveyType = chartId.includes('family') ? 'family' : 'faculty';
                const blob = await createCompositeImage(chartId, surveyType);

                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);

                btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Copied!';
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                // Fallback: trigger download instead
                btn.innerHTML = 'Downloading...';
                const surveyType = chartId.includes('family') ? 'family' : 'faculty';
                const blob = await createCompositeImage(chartId, surveyType);
                const link = document.createElement('a');
                link.download = `chart-${new Date().toISOString().split('T')[0]}.png`;
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            }
        }

        // Presentation Mode
        function togglePresentationMode() {
            document.body.classList.toggle('presentation-mode');
        }

        // Update Key Insight Banner
        function updateInsightBanner() {
            const familyCount = familyData.count || 0;
            const facultyCount = facultyData.count || 0;
            const totalResponses = familyCount + facultyCount;
            const familyPercent = Math.round((familyCount / CONFIG.familyGoal) * 100);
            const facultyPercent = Math.round((facultyCount / CONFIG.facultyGoal) * 100);

            // Calculate overall satisfaction
            let overallSatisfaction = 0;
            let questionCount = 0;

            [...familyData.distribution, ...facultyData.distribution].forEach(q => {
                if (!q) return;
                const total = (q['Strongly Agree'] || 0) + (q['Agree'] || 0) + (q['Disagree'] || 0) + (q['Strongly Disagree'] || 0);
                if (total > 0) {
                    const positive = ((q['Strongly Agree'] || 0) + (q['Agree'] || 0)) / total * 100;
                    overallSatisfaction += positive;
                    questionCount++;
                }
            });

            overallSatisfaction = questionCount > 0 ? Math.round(overallSatisfaction / questionCount) : 0;

            // Generate dynamic insight
            let headline = '';
            let detail = '';

            if (familyPercent >= 100 && facultyPercent >= 100) {
                headline = '🎉 Both surveys have reached their goals!';
                detail = `Amazing response with ${overallSatisfaction}% positive sentiment overall`;
            } else if (overallSatisfaction >= 80) {
                headline = '📈 Strong positive sentiment across responses';
                detail = `${totalResponses} total responses with ${overallSatisfaction}% expressing satisfaction`;
            } else if (overallSatisfaction >= 60) {
                headline = '📊 Steady progress with room to grow';
                detail = `${totalResponses} responses collected — some areas need attention`;
            } else if (totalResponses > 0) {
                headline = '⚠️ Mixed feedback — review concerns';
                detail = `${overallSatisfaction}% positive sentiment — check areas of concern`;
            } else {
                headline = '🚀 Survey collection in progress';
                detail = 'Waiting for responses to generate insights';
            }

            document.getElementById('insightHeadline').textContent = headline;
            document.getElementById('insightDetail').textContent = detail;
            document.getElementById('insightStatValue').textContent = overallSatisfaction + '%';
            document.getElementById('insightStatLabel').textContent = 'Positive';
        }

        // Update Response Velocity
        function updateVelocity(type, responses) {
            const velocityEl = document.getElementById(`${type}Velocity`);
            const velocityTextEl = document.getElementById(`${type}VelocityText`);
            if (!velocityEl || !velocityTextEl) return;

            // For family survey, we don't have timestamps, so estimate based on count
            if (type === 'family') {
                const count = familyData.count || 0;
                if (count > 50) {
                    velocityTextEl.textContent = 'Strong response rate';
                    velocityEl.classList.remove('slow');
                } else if (count > 20) {
                    velocityTextEl.textContent = 'Moderate activity';
                    velocityEl.classList.remove('slow');
                } else if (count > 0) {
                    velocityTextEl.textContent = 'Just getting started';
                    velocityEl.classList.add('slow');
                } else {
                    velocityTextEl.textContent = 'Awaiting responses';
                    velocityEl.classList.add('slow');
                }
                return;
            }

            // For faculty (Typeform), we have timestamps
            if (!responses || responses.length === 0) {
                velocityTextEl.textContent = 'Awaiting responses';
                velocityEl.classList.add('slow');
                return;
            }

            // Count responses in last 24 hours
            const now = new Date();
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
            const recentCount = responses.filter(r => new Date(r.submitted_at) > oneDayAgo).length;

            if (recentCount > 10) {
                velocityTextEl.textContent = `🔥 ${recentCount} responses today`;
                velocityEl.classList.remove('slow');
            } else if (recentCount > 0) {
                velocityTextEl.textContent = `${recentCount} response${recentCount > 1 ? 's' : ''} today`;
                velocityEl.classList.remove('slow');
            } else {
                velocityTextEl.textContent = 'No responses today';
                velocityEl.classList.add('slow');
            }
        }

        // Navigation
        function showHome() {
            document.getElementById('homeView').classList.remove('hidden');
            document.getElementById('familyDetail').classList.remove('active');
            document.getElementById('facultyDetail').classList.remove('active');
        }

        function showDetail(survey) {
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('familyDetail').classList.remove('active');
            document.getElementById('facultyDetail').classList.remove('active');

            if (survey === 'family') {
                document.getElementById('familyDetail').classList.add('active');
                if (!familyChart) createFamilyChart();
            } else {
                document.getElementById('facultyDetail').classList.add('active');
                if (!facultyChart) createFacultyChart();
            }
        }

        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                data.push(row);
            }
            return { headers, data };
        }

        // Analyze response distribution
        function analyzeResponses(data, headers) {
            const distribution = headers.map(() => ({
                'Strongly Agree': 0,
                'Agree': 0,
                'Disagree': 0,
                'Strongly Disagree': 0
            }));

            data.forEach(row => {
                headers.forEach((header, index) => {
                    const response = row[header];
                    if (distribution[index][response] !== undefined) {
                        distribution[index][response]++;
                    }
                });
            });

            return distribution;
        }

        // Calculate insights
        function calculateInsights(distribution, questionsFull) {
            let strongest = { index: 0, score: 0 };
            let weakest = { index: 0, score: 100 };

            distribution.forEach((q, i) => {
                const total = q['Strongly Agree'] + q['Agree'] + q['Disagree'] + q['Strongly Disagree'];
                if (total === 0) return;

                const positivePercent = ((q['Strongly Agree'] + q['Agree']) / total) * 100;

                if (positivePercent > strongest.score) {
                    strongest = { index: i, score: positivePercent };
                }
                if (positivePercent < weakest.score) {
                    weakest = { index: i, score: positivePercent };
                }
            });

            const overallPositive = distribution.reduce((sum, q) => {
                const total = q['Strongly Agree'] + q['Agree'] + q['Disagree'] + q['Strongly Disagree'];
                return sum + (total > 0 ? ((q['Strongly Agree'] + q['Agree']) / total) * 100 : 0);
            }, 0) / distribution.length;

            return {
                strongest: questionsFull[strongest.index],
                strongestValue: `${Math.round(strongest.score)}% positive`,
                weakest: questionsFull[weakest.index],
                weakestValue: `${Math.round(weakest.score)}% positive`,
                sentiment: overallPositive >= 70 ? 'Generally Positive' : overallPositive >= 50 ? 'Mixed' : 'Needs Attention',
                sentimentValue: `${Math.round(overallPositive)}% positive overall`
            };
        }

        // Create charts
        function createFamilyChart() {
            const ctx = document.getElementById('familyChart').getContext('2d');
            familyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: FAMILY_QUESTIONS,
                    datasets: [
                        { label: 'Strongly Agree', data: [], backgroundColor: COLORS.stronglyAgree, borderRadius: 4 },
                        { label: 'Agree', data: [], backgroundColor: COLORS.agree, borderRadius: 4 },
                        { label: 'Disagree', data: [], backgroundColor: COLORS.disagree, borderRadius: 4 },
                        { label: 'Strongly Disagree', data: [], backgroundColor: COLORS.stronglyDisagree, borderRadius: 4 }
                    ]
                },
                options: getChartOptions()
            });
            updateFamilyChart();
        }

        function createFacultyChart() {
            const ctx = document.getElementById('facultyChart').getContext('2d');
            facultyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: FACULTY_QUESTIONS,
                    datasets: [
                        { label: 'Strongly Agree', data: [], backgroundColor: COLORS.stronglyAgree, borderRadius: 4 },
                        { label: 'Agree', data: [], backgroundColor: COLORS.agree, borderRadius: 4 },
                        { label: 'Disagree', data: [], backgroundColor: COLORS.disagree, borderRadius: 4 },
                        { label: 'Strongly Disagree', data: [], backgroundColor: COLORS.stronglyDisagree, borderRadius: 4 }
                    ]
                },
                options: getChartOptions()
            });
            updateFacultyChart();
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#012141',
                        titleFont: { family: 'DM Sans', size: 12, weight: 500 },
                        bodyFont: { family: 'DM Sans', size: 11 },
                        padding: 14,
                        cornerRadius: 10,
                        borderColor: '#D4A012',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: {
                            font: { family: 'DM Sans', size: 10 },
                            color: '#012141',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        grid: { color: '#E8DFC9' },
                        ticks: {
                            font: { family: 'DM Sans', size: 11 },
                            color: '#012141'
                        }
                    }
                }
            };
        }

        function updateFamilyChart() {
            if (!familyChart || !familyData.distribution.length) return;

            familyChart.data.datasets[0].data = familyData.distribution.map(d => d['Strongly Agree'] || 0);
            familyChart.data.datasets[1].data = familyData.distribution.map(d => d['Agree'] || 0);
            familyChart.data.datasets[2].data = familyData.distribution.map(d => d['Disagree'] || 0);
            familyChart.data.datasets[3].data = familyData.distribution.map(d => d['Strongly Disagree'] || 0);
            familyChart.update('none');
        }

        function updateFacultyChart() {
            if (!facultyChart || !facultyData.distribution.length) return;

            facultyChart.data.datasets[0].data = facultyData.distribution.map(d => d['Strongly Agree'] || 0);
            facultyChart.data.datasets[1].data = facultyData.distribution.map(d => d['Agree'] || 0);
            facultyChart.data.datasets[2].data = facultyData.distribution.map(d => d['Disagree'] || 0);
            facultyChart.data.datasets[3].data = facultyData.distribution.map(d => d['Strongly Disagree'] || 0);
            facultyChart.update('none');
        }

        // Calculate satisfaction score from distribution
        function calculateSatisfactionScore(distribution) {
            if (!distribution || distribution.length === 0) return 0;

            let totalPositive = 0;
            let totalResponses = 0;

            distribution.forEach(q => {
                const sa = q['Strongly Agree'] || 0;
                const a = q['Agree'] || 0;
                const d = q['Disagree'] || 0;
                const sd = q['Strongly Disagree'] || 0;
                const total = sa + a + d + sd;

                if (total > 0) {
                    // Weight: SA=100, A=75, D=25, SD=0
                    const score = (sa * 100 + a * 75 + d * 25 + sd * 0) / total;
                    totalPositive += score;
                    totalResponses++;
                }
            });

            return totalResponses > 0 ? Math.round(totalPositive / totalResponses) : 0;
        }

        // Update satisfaction score display
        function updateSatisfactionDisplay(type, distribution) {
            const score = calculateSatisfactionScore(distribution);
            const circleEl = document.getElementById(`${type}ScoreCircle`);
            const descEl = document.getElementById(`${type}ScoreDesc`);

            if (!circleEl || !descEl) return;

            circleEl.textContent = score;

            // Update circle color based on score
            circleEl.classList.remove('high', 'medium', 'low');
            if (score >= 70) {
                circleEl.classList.add('high');
                descEl.textContent = 'Excellent - Strong positive sentiment';
            } else if (score >= 50) {
                circleEl.classList.add('medium');
                descEl.textContent = 'Moderate - Some areas of strength and areas for improvement';
            } else {
                circleEl.classList.add('low');
                descEl.textContent = 'Needs attention - Address concerns';
            }
        }

        // Trigger confetti celebration
        let familyConfettiShown = false;
        let facultyConfettiShown = false;

        function triggerConfetti(type) {
            if (type === 'family' && familyConfettiShown) return;
            if (type === 'faculty' && facultyConfettiShown) return;

            // Fire confetti
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const colors = ['#D4A012', '#F5C842', '#0D9488', '#2DD4BF', '#FFFFFF'];

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.7 },
                    colors: colors
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.7 },
                    colors: colors
                });

                if (Date.now() < animationEnd) {
                    requestAnimationFrame(frame);
                }
            }());

            if (type === 'family') familyConfettiShown = true;
            if (type === 'faculty') facultyConfettiShown = true;
        }

        // Detect areas of concern (questions below 60% positive)
        function detectConcerns(distribution, questionsFull) {
            const concerns = [];

            distribution.forEach((q, i) => {
                const total = q['Strongly Agree'] + q['Agree'] + q['Disagree'] + q['Strongly Disagree'];
                if (total === 0) return;

                const positivePercent = ((q['Strongly Agree'] + q['Agree']) / total) * 100;

                if (positivePercent < 60) {
                    concerns.push({
                        question: questionsFull[i],
                        percent: Math.round(positivePercent)
                    });
                }
            });

            return concerns.sort((a, b) => a.percent - b.percent);
        }

        // Update concern alerts display
        function updateConcernAlerts(type, distribution, questionsFull) {
            const container = document.getElementById(`${type}ConcernAlerts`);
            if (!container) return;

            const concerns = detectConcerns(distribution, questionsFull);

            if (concerns.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = concerns.slice(0, 3).map(c => `
                <div class="concern-alert">
                    <svg class="concern-alert-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <div class="concern-alert-content">
                        <div class="concern-alert-title">Needs Attention (${c.percent}% positive)</div>
                        <div class="concern-alert-text">${c.question}</div>
                    </div>
                </div>
            `).join('');
        }

        // Create timeline chart for response history
        function createFacultyTimelineChart() {
            const ctx = document.getElementById('facultyTimelineChart');
            if (!ctx) return;

            facultyTimelineChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cumulative Responses',
                        data: [],
                        borderColor: '#D4A012',
                        backgroundColor: 'rgba(212, 160, 18, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#D4A012',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#012141',
                            titleFont: { family: 'DM Sans', size: 11 },
                            bodyFont: { family: 'DM Sans', size: 10 },
                            padding: 10,
                            cornerRadius: 8,
                            borderColor: '#D4A012',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { family: 'DM Sans', size: 9 },
                                color: '#012141',
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#E8DFC9' },
                            ticks: {
                                font: { family: 'DM Sans', size: 9 },
                                color: '#012141',
                                stepSize: 5
                            }
                        }
                    }
                }
            });
        }

        // Update timeline chart with response data
        function updateFacultyTimelineChart(responses) {
            if (!facultyTimelineChart) {
                createFacultyTimelineChart();
            }
            if (!facultyTimelineChart || !responses.length) return;

            // Group responses by date
            const dateMap = {};
            responses.forEach(resp => {
                if (resp.submitted_at) {
                    const date = new Date(resp.submitted_at);
                    const dateKey = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    dateMap[dateKey] = (dateMap[dateKey] || 0) + 1;
                }
            });

            // Sort dates and calculate cumulative
            const sortedDates = Object.keys(dateMap).sort((a, b) => {
                return new Date(a + ', 2025') - new Date(b + ', 2025');
            });

            let cumulative = 0;
            const cumulativeData = sortedDates.map(date => {
                cumulative += dateMap[date];
                return cumulative;
            });

            // Update chart
            facultyTimelineChart.data.labels = sortedDates;
            facultyTimelineChart.data.datasets[0].data = cumulativeData;
            facultyTimelineChart.update('none');
        }

        // Fetch Family Survey data
        async function fetchFamilyData() {
            try {
                const response = await fetch(CONFIG.familyCSVUrl);
                const csv = await response.text();
                const { headers, data } = parseCSV(csv);

                const count = data.length;
                const percent = Math.min(100, Math.round((count / CONFIG.familyGoal) * 100));

                // Update home view
                document.getElementById('familyCount').textContent = count.toLocaleString();
                document.getElementById('familyRate').textContent = `${percent}%`;
                document.getElementById('familyPercent').textContent = `${percent}%`;
                document.getElementById('familyProgress').style.width = `${Math.min(100, percent)}%`;
                document.getElementById('familyGoalText').textContent = count.toLocaleString();

                const badge = document.getElementById('familyBadge');
                if (count >= CONFIG.familyGoal) {
                    badge.textContent = 'Goal Met!';
                    badge.className = 'card-badge goal-met';
                    triggerConfetti('family');
                } else {
                    badge.textContent = 'In Progress';
                    badge.className = 'card-badge in-progress';
                }

                // Update detail view
                document.getElementById('familyDetailCount').textContent = count.toLocaleString();
                document.getElementById('familyDetailPercent').textContent = `${percent}%`;

                // Separate Likert headers from free response headers
                const likertHeaders = headers.filter(h => !h.toLowerCase().includes('free') && !h.toLowerCase().includes('response') && !h.toLowerCase().includes('comment') && !h.toLowerCase().includes('feedback'));
                const freeResponseHeaders = headers.filter(h => h.toLowerCase().includes('free') || h.toLowerCase().includes('response') || h.toLowerCase().includes('comment') || h.toLowerCase().includes('feedback'));

                // Store distribution and update chart (only for Likert questions)
                familyData.distribution = analyzeResponses(data, likertHeaders);
                familyData.count = count;

                // Extract free responses
                const feedback = [];
                data.forEach(row => {
                    freeResponseHeaders.forEach(header => {
                        if (row[header] && row[header].trim()) {
                            feedback.push({ text: row[header].trim() });
                        }
                    });
                    // Also check for "Free_Response" column specifically
                    if (row['Free_Response'] && row['Free_Response'].trim()) {
                        if (!feedback.find(f => f.text === row['Free_Response'].trim())) {
                            feedback.push({ text: row['Free_Response'].trim() });
                        }
                    }
                });
                familyData.feedback = feedback;

                updateFamilyChart();

                // Update insights
                if (count > 0) {
                    const insights = calculateInsights(familyData.distribution, FAMILY_QUESTIONS_FULL);
                    document.getElementById('familyStrongest').textContent = insights.strongest;
                    document.getElementById('familyStrongestValue').textContent = insights.strongestValue;
                    document.getElementById('familyWeakest').textContent = insights.weakest;
                    document.getElementById('familyWeakestValue').textContent = insights.weakestValue;
                    document.getElementById('familySentiment').textContent = insights.sentiment;
                    document.getElementById('familySentimentValue').textContent = insights.sentimentValue;

                    // Update satisfaction score
                    updateSatisfactionDisplay('family', familyData.distribution);

                    // Update concern alerts
                    updateConcernAlerts('family', familyData.distribution, FAMILY_QUESTIONS_FULL);
                }

                // Update feedback section
                const feedbackContainer = document.getElementById('familyFeedback');
                if (feedbackContainer && feedback.length > 0) {
                    feedbackContainer.innerHTML = feedback.slice(0, 5).map(f => `
                        <div class="feedback-item positive">
                            <div class="feedback-text">"${f.text}"</div>
                            <div class="feedback-type">Family feedback</div>
                        </div>
                    `).join('');
                } else if (feedbackContainer) {
                    feedbackContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">No feedback submitted yet.</p>';
                }

                // Update velocity and insights
                updateVelocity('family', null);
                updateInsightBanner();

            } catch (error) {
                console.error('Error fetching family data:', error);
            }
        }

        // Fetch Faculty Survey data from Typeform
        async function fetchFacultyData() {
            try {
                const response = await fetch('/api/typeform');
                const data = await response.json();
                const responses = data.items || [];
                const count = responses.length;
                const percent = Math.min(100, Math.round((count / CONFIG.facultyGoal) * 100));

                // Update home view
                document.getElementById('facultyCount').textContent = count.toLocaleString();
                document.getElementById('facultyRate').textContent = `${percent}%`;
                document.getElementById('facultyPercent').textContent = `${percent}%`;
                document.getElementById('facultyProgress').style.width = `${Math.min(100, percent)}%`;
                document.getElementById('facultyGoalText').textContent = count.toLocaleString();

                const badge = document.getElementById('facultyBadge');
                if (count >= CONFIG.facultyGoal) {
                    badge.textContent = 'Goal Met!';
                    badge.className = 'card-badge goal-met';
                    triggerConfetti('faculty');
                } else {
                    badge.textContent = 'In Progress';
                    badge.className = 'card-badge in-progress';
                }

                // Update detail view
                document.getElementById('facultyDetailCount').textContent = count.toLocaleString();
                document.getElementById('facultyDetailPercent').textContent = `${percent}%`;

                // Analyze Typeform responses
                const distribution = FACULTY_QUESTIONS.map(() => ({
                    'Strongly Agree': 0,
                    'Agree': 0,
                    'Disagree': 0,
                    'Strongly Disagree': 0
                }));

                const questionFieldIds = [
                    'q4QdVXMAes63',
                    'k3BbbaohVfkp',
                    'b5DFCh8LrRgk',
                    'Q5h9fIVf2ShA',
                    'tAVh4ZMZJn66'
                ];

                const feedbackFieldIds = {
                    positive: '8YZikKxFBzDV',
                    concerns: 'oURZDVN67s4b'
                };

                const feedback = [];

                responses.forEach(resp => {
                    if (resp.answers) {
                        resp.answers.forEach(answer => {
                            const qIndex = questionFieldIds.indexOf(answer.field?.id);
                            if (qIndex !== -1 && answer.choice?.label) {
                                // Normalize label: "Strongly agree" -> "Strongly Agree"
                                const rawLabel = answer.choice.label;
                                const label = rawLabel.split(' ').map(word =>
                                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                ).join(' ');
                                if (distribution[qIndex][label] !== undefined) {
                                    distribution[qIndex][label]++;
                                }
                            }

                            if (answer.field?.id === feedbackFieldIds.positive && answer.text) {
                                feedback.push({ type: 'positive', text: answer.text });
                            }
                            if (answer.field?.id === feedbackFieldIds.concerns && answer.text) {
                                feedback.push({ type: 'concern', text: answer.text });
                            }
                        });
                    }
                });

                facultyData.distribution = distribution;
                facultyData.count = count;
                facultyData.feedback = feedback;
                facultyData.timeline = responses;
                updateFacultyChart();
                updateFacultyTimelineChart(responses);

                // Update insights
                if (count > 0) {
                    const insights = calculateInsights(distribution, FACULTY_QUESTIONS_FULL);
                    document.getElementById('facultyStrongest').textContent = insights.strongest;
                    document.getElementById('facultyStrongestValue').textContent = insights.strongestValue;
                    document.getElementById('facultyWeakest').textContent = insights.weakest;
                    document.getElementById('facultyWeakestValue').textContent = insights.weakestValue;

                    // Update satisfaction score
                    updateSatisfactionDisplay('faculty', distribution);

                    // Update concern alerts
                    updateConcernAlerts('faculty', distribution, FACULTY_QUESTIONS_FULL);
                }

                // Update feedback section
                const feedbackContainer = document.getElementById('facultyFeedback');
                feedbackContainer.innerHTML = feedback.slice(0, 4).map(f => `
                    <div class="feedback-item ${f.type}">
                        <div class="feedback-text">"${f.text}"</div>
                        <div class="feedback-type">${f.type === 'positive' ? 'Positive feedback' : 'Suggestion/Concern'}</div>
                    </div>
                `).join('');

                // Update velocity and insights
                updateVelocity('faculty', responses);
                updateInsightBanner();

            } catch (error) {
                console.error('Error fetching faculty data:', error);
            }
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('lastUpdated').textContent = `Updated ${time}`;
        }

        // ============================================
        // AI CHAT FUNCTIONALITY
        // ============================================

        // Build survey context for Claude
        function buildSurveyContext(surveyType) {
            const data = surveyType === 'family' ? familyData : facultyData;
            const questions = surveyType === 'family' ? FAMILY_QUESTIONS_FULL : FACULTY_QUESTIONS_FULL;

            // Calculate percentages for each question
            const distributionWithPercents = data.distribution.map((dist, i) => {
                const total = Object.values(dist).reduce((a, b) => a + b, 0);
                if (total === 0) return { question: questions[i], responses: dist };

                const percents = {};
                for (const [key, val] of Object.entries(dist)) {
                    percents[key] = `${Math.round((val / total) * 100)}%`;
                }
                return { question: questions[i], responses: percents, rawCounts: dist };
            });

            return {
                distribution: distributionWithPercents,
                questions: questions,
                feedback: data.feedback.slice(0, 20), // Limit feedback to avoid token limits
                count: data.count
            };
        }

        // Send message to Claude API
        async function sendToClaudeAPI(question, surveyType) {
            const surveyData = buildSurveyContext(surveyType);

            const response = await fetch('/api/claude', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question: question,
                    surveyData: surveyData,
                    surveyType: surveyType
                })
            });

            if (!response.ok) {
                throw new Error('Failed to get response from Claude');
            }

            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }

            return result.response;
        }

        // Render a chat message
        function renderChatMessage(surveyType, role, content) {
            const messagesContainer = document.getElementById(`${surveyType}ChatMessages`);
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            if (role === 'assistant') {
                // Simple markdown-like formatting
                content = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n- /g, '</p><ul><li>')
                    .replace(/\n(\d+)\. /g, '</p><ol><li>')
                    .replace(/<\/li>(?=<li>)/g, '</li>')
                    .replace(/<li>([^<]*?)(?=<\/p>|<li>|$)/g, '<li>$1</li>');

                if (content.includes('<ul>')) {
                    content = content.replace(/<\/p><ul>/g, '<ul>').replace(/<ul>(?!.*<\/ul>)/g, '<ul>') + '</ul>';
                }
                if (content.includes('<ol>')) {
                    content = content.replace(/<\/p><ol>/g, '<ol>').replace(/<ol>(?!.*<\/ol>)/g, '<ol>') + '</ol>';
                }

                messageDiv.innerHTML = `<p>${content}</p>`;
            } else {
                messageDiv.textContent = content;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageDiv;
        }

        // Handle sending a chat message
        async function sendChatMessage(surveyType) {
            const input = document.getElementById(`${surveyType}ChatInput`);
            const sendBtn = document.getElementById(`${surveyType}SendBtn`);
            const question = input.value.trim();

            if (!question) return;

            // Clear input and disable send
            input.value = '';
            sendBtn.disabled = true;

            // Hide suggestions after first message
            document.getElementById(`${surveyType}ChatSuggestions`).style.display = 'none';

            // Render user message
            renderChatMessage(surveyType, 'user', question);

            // Show loading message
            const loadingMsg = renderChatMessage(surveyType, 'assistant loading', 'Analyzing');

            try {
                const response = await sendToClaudeAPI(question, surveyType);

                // Remove loading message and show response
                loadingMsg.remove();
                renderChatMessage(surveyType, 'assistant', response);
            } catch (error) {
                loadingMsg.remove();
                renderChatMessage(surveyType, 'assistant', `Sorry, I encountered an error: ${error.message}. Please try again.`);
            }

            sendBtn.disabled = false;
            input.focus();
        }

        // Handle Enter key in chat input
        function handleChatKeypress(event, surveyType) {
            if (event.key === 'Enter') {
                sendChatMessage(surveyType);
            }
        }

        // Handle suggestion button clicks
        function askSuggestion(surveyType, question) {
            document.getElementById(`${surveyType}ChatInput`).value = question;
            sendChatMessage(surveyType);
        }

        // Initialize
        async function init() {
            await Promise.all([fetchFamilyData(), fetchFacultyData()]);
            updateTimestamp();
        }

        // Auto-refresh
        setInterval(init, CONFIG.refreshInterval);

        // Initial load
        init();
    </script>
</body>
</html>
