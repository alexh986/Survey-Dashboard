<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Pulse | School Climate Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Sky blue foundation */
            --bg-primary: #28AAE1;
            --bg-card: #FFFFFF;
            --bg-card-hover: #FAFCFF;
            --bg-muted: #F0F6F9;

            /* Deep navy text */
            --text-primary: #012141;
            --text-secondary: #012141;
            --text-muted: #1A4A6E;
            --text-on-blue: #FFFFFF;

            /* Brand colors */
            --accent-primary: #012141;
            --accent-gold: #D4A012;
            --accent-gold-light: #F5C842;
            --accent-glow: rgba(212, 160, 18, 0.2);

            /* Gold borders */
            --border: #D4A012;
            --border-light: #E8C547;
            --border-subtle: #E8DFC9;

            /* Survey response colors */
            --strongly-agree: #0D9488;
            --agree: #2DD4BF;
            --disagree: #F59E0B;
            --strongly-disagree: #E11D48;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(1, 33, 65, 0.1);
            --shadow-md: 0 8px 30px rgba(1, 33, 65, 0.15);
            --shadow-lg: 0 20px 50px rgba(1, 33, 65, 0.2);

            /* Alert colors */
            --alert-warning: #DC2626;
            --alert-warning-bg: rgba(220, 38, 38, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Sky blue background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #28AAE1;
            pointer-events: none;
            z-index: -1;
        }

        header {
            padding: 1.25rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(40, 170, 225, 0.95);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .brand:hover {
            opacity: 0.9;
        }

        .brand-icon {
            width: 38px;
            height: 38px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .brand-icon svg {
            width: 20px;
            height: 20px;
            fill: #28AAE1;
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.4rem;
            letter-spacing: -0.02em;
            color: white;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: blink 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(212, 160, 18, 0.6);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .last-updated {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.75);
        }

        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* HOME VIEW */
        .home-view {
            display: block;
        }

        .home-view.hidden {
            display: none;
        }

        .page-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.9rem;
            margin-bottom: 0.4rem;
            letter-spacing: -0.02em;
            color: white;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            margin-bottom: 2.25rem;
        }

        .survey-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .survey-card {
            background: var(--bg-card);
            border: 2px solid var(--accent-gold);
            border-radius: 20px;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .survey-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-gold-light));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .survey-card:hover {
            background: var(--bg-card);
            border-color: var(--accent-gold-light);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(212, 160, 18, 0.2);
        }

        .survey-card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .card-title-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(10, 22, 40, 0.08), rgba(10, 22, 40, 0.04));
            border: 1px solid rgba(212, 160, 18, 0.3);
        }

        .card-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--text-primary);
        }

        .card-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.2rem;
        }

        .card-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .card-badge.in-progress {
            background: rgba(212, 160, 18, 0.15);
            color: #B8860B;
        }

        .card-badge.goal-met {
            background: rgba(13, 148, 136, 0.15);
            color: var(--strongly-agree);
        }

        .metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric {
            background: var(--bg-muted);
            border-radius: 12px;
            padding: 1.1rem;
            border: 1px solid rgba(212, 160, 18, 0.25);
        }

        .metric-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 0.4rem;
        }

        .metric-value {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            letter-spacing: -0.03em;
            color: var(--text-primary);
        }

        .progress-section {
            margin-top: 0.5rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .progress-percentage {
            font-family: 'Fraunces', serif;
            font-weight: 600;
            font-size: 0.95rem;
            color: #B8860B;
        }

        .progress-bar-bg {
            height: 8px;
            background: var(--bg-muted);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-gold-light));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: shimmer 2.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .goal-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .view-details {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-subtle);
            font-size: 0.8rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .view-details svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
            transition: transform 0.2s;
        }

        .survey-card:hover .view-details svg {
            transform: translateX(4px);
        }

        /* DETAIL VIEW */
        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: color 0.2s;
            background: none;
            border: none;
            font-family: inherit;
        }

        .back-button:hover {
            color: white;
        }

        .back-button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .detail-title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .detail-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid var(--accent-gold);
            box-shadow: var(--shadow-sm);
        }

        .detail-icon svg {
            width: 30px;
            height: 30px;
            fill: var(--text-primary);
        }

        .detail-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.5rem;
            color: white;
        }

        .detail-subtitle {
            color: rgba(255, 255, 255, 0.75);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .detail-stats {
            display: flex;
            gap: 2rem;
            text-align: right;
        }

        .detail-stat-value {
            font-family: 'Fraunces', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: white;
        }

        .detail-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.7);
        }

        .detail-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .chart-panel {
            background: var(--bg-card);
            border: 2px solid var(--accent-gold);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
        }

        .panel-title {
            font-family: 'Fraunces', serif;
            font-weight: 500;
            font-size: 1.05rem;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
        }

        .chart-wrapper {
            height: 320px;
        }

        .insights-panel {
            background: var(--bg-card);
            border: 2px solid var(--accent-gold);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
        }

        .insight-card {
            background: var(--bg-muted);
            border-radius: 12px;
            padding: 1.1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(212, 160, 18, 0.2);
            transition: border-color 0.2s;
        }

        .insight-card:hover {
            border-color: var(--accent-gold);
        }

        .insight-card:last-child {
            margin-bottom: 0;
        }

        .insight-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .insight-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .insight-value {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .insight-value.positive {
            color: var(--strongly-agree);
        }

        .insight-value.negative {
            color: var(--strongly-disagree);
        }

        .feedback-section {
            margin-top: 1rem;
        }

        .feedback-item {
            background: var(--bg-muted);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--accent-gold);
            transition: transform 0.2s;
        }

        .feedback-item:hover {
            transform: translateX(2px);
        }

        .feedback-item.positive {
            border-left-color: var(--strongly-agree);
            background: linear-gradient(90deg, rgba(13, 148, 136, 0.08), var(--bg-muted));
        }

        .feedback-item.concern {
            border-left-color: var(--disagree);
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.08), var(--bg-muted));
        }

        .feedback-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
            line-height: 1.55;
        }

        /* Satisfaction Score */
        .satisfaction-score {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: linear-gradient(135deg, var(--bg-muted), #E8F4F8);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(212, 160, 18, 0.2);
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Fraunces', serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .score-circle.high {
            background: linear-gradient(135deg, var(--strongly-agree), #10B981);
        }

        .score-circle.medium {
            background: linear-gradient(135deg, var(--disagree), #FBBF24);
        }

        .score-circle.low {
            background: linear-gradient(135deg, var(--strongly-disagree), #F87171);
        }

        .score-details {
            flex: 1;
        }

        .score-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .score-description {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-top: 0.2rem;
        }

        /* Concern Alert */
        .concern-alert {
            background: var(--alert-warning-bg);
            border: 1px solid var(--alert-warning);
            border-radius: 10px;
            padding: 0.85rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .concern-alert-icon {
            width: 20px;
            height: 20px;
            fill: var(--alert-warning);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .concern-alert-content {
            flex: 1;
        }

        .concern-alert-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--alert-warning);
            margin-bottom: 0.2rem;
        }

        .concern-alert-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Goal Met Celebration */
        .goal-met-banner {
            background: linear-gradient(135deg, var(--strongly-agree), #10B981);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 1rem;
            animation: celebratePulse 2s ease-in-out infinite;
        }

        @keyframes celebratePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Trend Chart Container */
        .trend-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-subtle);
        }

        .trend-chart-wrapper {
            height: 120px;
            margin-top: 0.75rem;
        }

        .feedback-type {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 1.25rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-dot.sa { background: var(--strongly-agree); }
        .legend-dot.a { background: var(--agree); }
        .legend-dot.d { background: var(--disagree); }
        .legend-dot.sd { background: var(--strongly-disagree); }

        @media (max-width: 1000px) {
            .survey-cards {
                grid-template-columns: 1fr;
            }

            .detail-content {
                grid-template-columns: 1fr;
            }

            .detail-header {
                flex-direction: column;
                gap: 1rem;
            }

            .detail-stats {
                text-align: left;
            }
        }

        @media (max-width: 600px) {
            header {
                padding: 1rem;
            }

            main {
                padding: 1rem;
            }

            .metrics-row {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <header>
        <div class="header-content">
            <div class="brand" onclick="showHome()">
                <div class="brand-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <h1>Survey Pulse</h1>
            </div>
            <div class="status-bar">
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    Live
                </div>
                <span class="last-updated" id="lastUpdated">Updating...</span>
            </div>
        </div>
    </header>

    <main>
        <!-- HOME VIEW -->
        <div class="home-view" id="homeView">
            <h2 class="page-title">School Climate Surveys</h2>
            <p class="page-subtitle">Real-time response tracking and insights</p>

            <div class="survey-cards">
                <!-- Family Survey Card -->
                <div class="survey-card" onclick="showDetail('family')">
                    <div class="card-header">
                        <div class="card-title-section">
                            <div class="card-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                                </svg>
                            </div>
                            <span class="card-title">Family Survey</span>
                        </div>
                        <span class="card-badge in-progress" id="familyBadge">In Progress</span>
                    </div>

                    <div class="metrics-row">
                        <div class="metric">
                            <div class="metric-label">Total Responses</div>
                            <div class="metric-value" id="familyCount">—</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Completion</div>
                            <div class="metric-value" id="familyRate">—</div>
                        </div>
                    </div>

                    <div class="satisfaction-score" id="familySatisfactionCard">
                        <div class="score-circle high" id="familyScoreCircle">—</div>
                        <div class="score-details">
                            <div class="score-label">Satisfaction Score</div>
                            <div class="score-description" id="familyScoreDesc">Calculating...</div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Progress to Goal</span>
                            <span class="progress-percentage" id="familyPercent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="familyProgress" style="width: 0%"></div>
                        </div>
                        <p class="goal-text"><span id="familyGoalText">0</span> of <strong>1,000</strong> goal</p>
                    </div>

                    <div class="view-details">
                        View Details & Insights
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>

                <!-- Faculty Survey Card -->
                <div class="survey-card" onclick="showDetail('faculty')">
                    <div class="card-header">
                        <div class="card-title-section">
                            <div class="card-icon">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                                </svg>
                            </div>
                            <span class="card-title">Faculty Survey</span>
                        </div>
                        <span class="card-badge in-progress" id="facultyBadge">In Progress</span>
                    </div>

                    <div class="metrics-row">
                        <div class="metric">
                            <div class="metric-label">Total Responses</div>
                            <div class="metric-value" id="facultyCount">—</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Completion</div>
                            <div class="metric-value" id="facultyRate">—</div>
                        </div>
                    </div>

                    <div class="satisfaction-score" id="facultySatisfactionCard">
                        <div class="score-circle high" id="facultyScoreCircle">—</div>
                        <div class="score-details">
                            <div class="score-label">Satisfaction Score</div>
                            <div class="score-description" id="facultyScoreDesc">Calculating...</div>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Progress to Goal</span>
                            <span class="progress-percentage" id="facultyPercent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="facultyProgress" style="width: 0%"></div>
                        </div>
                        <p class="goal-text"><span id="facultyGoalText">0</span> of <strong>85</strong> goal</p>
                    </div>

                    <div class="view-details">
                        View Details & Insights
                        <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAMILY DETAIL VIEW -->
        <div class="detail-view" id="familyDetail">
            <button class="back-button" onclick="showHome()">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                Back to Overview
            </button>

            <div class="detail-header">
                <div class="detail-title-section">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="detail-title">Family Survey</h2>
                        <p class="detail-subtitle">13 questions · School climate & satisfaction</p>
                    </div>
                </div>
                <div class="detail-stats">
                    <div>
                        <div class="detail-stat-value" id="familyDetailCount">—</div>
                        <div class="detail-stat-label">Responses</div>
                    </div>
                    <div>
                        <div class="detail-stat-value" id="familyDetailPercent">—</div>
                        <div class="detail-stat-label">To Goal</div>
                    </div>
                </div>
            </div>

            <div class="detail-content">
                <div class="chart-panel">
                    <h3 class="panel-title">Response Distribution by Question</h3>
                    <div class="chart-wrapper">
                        <canvas id="familyChart"></canvas>
                    </div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-dot sa"></div> Strongly Agree</div>
                        <div class="legend-item"><div class="legend-dot a"></div> Agree</div>
                        <div class="legend-item"><div class="legend-dot d"></div> Disagree</div>
                        <div class="legend-item"><div class="legend-dot sd"></div> Strongly Disagree</div>
                    </div>
                </div>

                <div class="insights-panel">
                    <h3 class="panel-title">Emerging Insights</h3>

                    <div id="familyConcernAlerts">
                        <!-- Concern alerts populated by JS -->
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Strongest Area</div>
                        <div class="insight-title" id="familyStrongest">Loading...</div>
                        <div class="insight-value positive" id="familyStrongestValue">—</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Area for Growth</div>
                        <div class="insight-title" id="familyWeakest">Loading...</div>
                        <div class="insight-value negative" id="familyWeakestValue">—</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Overall Sentiment</div>
                        <div class="insight-title" id="familySentiment">Loading...</div>
                        <div class="insight-value" id="familySentimentValue">—</div>
                    </div>

                    <div class="feedback-section">
                        <div class="insight-label">Family Feedback</div>
                        <div id="familyFeedback">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FACULTY DETAIL VIEW -->
        <div class="detail-view" id="facultyDetail">
            <button class="back-button" onclick="showHome()">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                Back to Overview
            </button>

            <div class="detail-header">
                <div class="detail-title-section">
                    <div class="detail-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="detail-title">Faculty Survey</h2>
                        <p class="detail-subtitle">5 rated questions + open feedback</p>
                    </div>
                </div>
                <div class="detail-stats">
                    <div>
                        <div class="detail-stat-value" id="facultyDetailCount">—</div>
                        <div class="detail-stat-label">Responses</div>
                    </div>
                    <div>
                        <div class="detail-stat-value" id="facultyDetailPercent">—</div>
                        <div class="detail-stat-label">To Goal</div>
                    </div>
                </div>
            </div>

            <div class="detail-content">
                <div class="chart-panel">
                    <h3 class="panel-title">Response Distribution by Question</h3>
                    <div class="chart-wrapper">
                        <canvas id="facultyChart"></canvas>
                    </div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-dot sa"></div> Strongly Agree</div>
                        <div class="legend-item"><div class="legend-dot a"></div> Agree</div>
                        <div class="legend-item"><div class="legend-dot d"></div> Disagree</div>
                        <div class="legend-item"><div class="legend-dot sd"></div> Strongly Disagree</div>
                    </div>

                    <div class="trend-section">
                        <h4 class="panel-title" style="margin-bottom: 0.5rem; font-size: 0.95rem;">Response Timeline</h4>
                        <div class="trend-chart-wrapper">
                            <canvas id="facultyTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="insights-panel">
                    <h3 class="panel-title">Emerging Insights</h3>

                    <div id="facultyConcernAlerts">
                        <!-- Concern alerts populated by JS -->
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Strongest Area</div>
                        <div class="insight-title" id="facultyStrongest">Loading...</div>
                        <div class="insight-value positive" id="facultyStrongestValue">—</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Area for Growth</div>
                        <div class="insight-title" id="facultyWeakest">Loading...</div>
                        <div class="insight-value negative" id="facultyWeakestValue">—</div>
                    </div>

                    <div class="feedback-section">
                        <div class="insight-label">Recent Feedback</div>
                        <div id="facultyFeedback">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const CONFIG = {
            familyCSVUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT8pRoz4n4UvsQTCtGZnGuVle3OfuFDsldtKPKpHTapaoKnk8glLNolfPclWgeL512OrHb4HD0eDw40/pub?output=csv',
            familyGoal: 1000,
            facultyGoal: 85,
            refreshInterval: 30000
        };

        const COLORS = {
            stronglyAgree: '#0D9488',
            agree: '#2DD4BF',
            disagree: '#F59E0B',
            stronglyDisagree: '#E11D48'
        };

        const FAMILY_QUESTIONS = [
            'Safe at school',
            'Welcomed & respected',
            'Teachers care',
            'Appropriately challenged',
            'Clear communication',
            'Comfortable reaching out',
            'Social-emotional support',
            'Values DEI',
            'Enjoys school',
            'Overall satisfaction',
            'Responds to feedback',
            'Informed on progress',
            'Would recommend'
        ];

        const FAMILY_QUESTIONS_FULL = [
            'My child feels safe at school',
            'My child feels welcomed and respected',
            'Teachers care about my child\'s learning',
            'My child is challenged appropriately',
            'School communicates clearly with families',
            'I feel comfortable reaching out to teachers',
            'School supports social/emotional development',
            'School values diversity, equity, inclusion',
            'My child enjoys coming to school',
            'Overall satisfaction',
            'School responds to family feedback',
            'I feel informed about academic progress',
            'I would recommend this school'
        ];

        const FACULTY_QUESTIONS = [
            'Org culture',
            'Team mission',
            'Feedback',
            'Communication',
            'Ideas valued'
        ];

        const FACULTY_QUESTIONS_FULL = [
            'Satisfied with organizational culture',
            'Team connected to mission',
            'Receive constructive feedback',
            'Team communication is effective',
            'Ideas and input are valued'
        ];

        let familyChart, facultyChart, facultyTimelineChart;
        let familyData = { distribution: [], count: 0, feedback: [] };
        let facultyData = { distribution: [], count: 0, feedback: [], timeline: [] };

        // Navigation
        function showHome() {
            document.getElementById('homeView').classList.remove('hidden');
            document.getElementById('familyDetail').classList.remove('active');
            document.getElementById('facultyDetail').classList.remove('active');
        }

        function showDetail(survey) {
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('familyDetail').classList.remove('active');
            document.getElementById('facultyDetail').classList.remove('active');

            if (survey === 'family') {
                document.getElementById('familyDetail').classList.add('active');
                if (!familyChart) createFamilyChart();
            } else {
                document.getElementById('facultyDetail').classList.add('active');
                if (!facultyChart) createFacultyChart();
            }
        }

        // Parse CSV data
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                });
                data.push(row);
            }
            return { headers, data };
        }

        // Analyze response distribution
        function analyzeResponses(data, headers) {
            const distribution = headers.map(() => ({
                'Strongly Agree': 0,
                'Agree': 0,
                'Disagree': 0,
                'Strongly Disagree': 0
            }));

            data.forEach(row => {
                headers.forEach((header, index) => {
                    const response = row[header];
                    if (distribution[index][response] !== undefined) {
                        distribution[index][response]++;
                    }
                });
            });

            return distribution;
        }

        // Calculate insights
        function calculateInsights(distribution, questionsFull) {
            let strongest = { index: 0, score: 0 };
            let weakest = { index: 0, score: 100 };

            distribution.forEach((q, i) => {
                const total = q['Strongly Agree'] + q['Agree'] + q['Disagree'] + q['Strongly Disagree'];
                if (total === 0) return;

                const positivePercent = ((q['Strongly Agree'] + q['Agree']) / total) * 100;

                if (positivePercent > strongest.score) {
                    strongest = { index: i, score: positivePercent };
                }
                if (positivePercent < weakest.score) {
                    weakest = { index: i, score: positivePercent };
                }
            });

            const overallPositive = distribution.reduce((sum, q) => {
                const total = q['Strongly Agree'] + q['Agree'] + q['Disagree'] + q['Strongly Disagree'];
                return sum + (total > 0 ? ((q['Strongly Agree'] + q['Agree']) / total) * 100 : 0);
            }, 0) / distribution.length;

            return {
                strongest: questionsFull[strongest.index],
                strongestValue: `${Math.round(strongest.score)}% positive`,
                weakest: questionsFull[weakest.index],
                weakestValue: `${Math.round(weakest.score)}% positive`,
                sentiment: overallPositive >= 70 ? 'Generally Positive' : overallPositive >= 50 ? 'Mixed' : 'Needs Attention',
                sentimentValue: `${Math.round(overallPositive)}% positive overall`
            };
        }

        // Create charts
        function createFamilyChart() {
            const ctx = document.getElementById('familyChart').getContext('2d');
            familyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: FAMILY_QUESTIONS,
                    datasets: [
                        { label: 'Strongly Agree', data: [], backgroundColor: COLORS.stronglyAgree, borderRadius: 4 },
                        { label: 'Agree', data: [], backgroundColor: COLORS.agree, borderRadius: 4 },
                        { label: 'Disagree', data: [], backgroundColor: COLORS.disagree, borderRadius: 4 },
                        { label: 'Strongly Disagree', data: [], backgroundColor: COLORS.stronglyDisagree, borderRadius: 4 }
                    ]
                },
                options: getChartOptions()
            });
            updateFamilyChart();
        }

        function createFacultyChart() {
            const ctx = document.getElementById('facultyChart').getContext('2d');
            facultyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: FACULTY_QUESTIONS,
                    datasets: [
                        { label: 'Strongly Agree', data: [], backgroundColor: COLORS.stronglyAgree, borderRadius: 4 },
                        { label: 'Agree', data: [], backgroundColor: COLORS.agree, borderRadius: 4 },
                        { label: 'Disagree', data: [], backgroundColor: COLORS.disagree, borderRadius: 4 },
                        { label: 'Strongly Disagree', data: [], backgroundColor: COLORS.stronglyDisagree, borderRadius: 4 }
                    ]
                },
                options: getChartOptions()
            });
            updateFacultyChart();
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#012141',
                        titleFont: { family: 'DM Sans', size: 12, weight: 500 },
                        bodyFont: { family: 'DM Sans', size: 11 },
                        padding: 14,
                        cornerRadius: 10,
                        borderColor: '#D4A012',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: {
                            font: { family: 'DM Sans', size: 10 },
                            color: '#012141',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        grid: { color: '#E8DFC9' },
                        ticks: {
                            font: { family: 'DM Sans', size: 11 },
                            color: '#012141'
                        }
                    }
                }
            };
        }

        function updateFamilyChart() {
            if (!familyChart || !familyData.distribution.length) return;

            familyChart.data.datasets[0].data = familyData.distribution.map(d => d['Strongly Agree'] || 0);
            familyChart.data.datasets[1].data = familyData.distribution.map(d => d['Agree'] || 0);
            familyChart.data.datasets[2].data = familyData.distribution.map(d => d['Disagree'] || 0);
            familyChart.data.datasets[3].data = familyData.distribution.map(d => d['Strongly Disagree'] || 0);
            familyChart.update('none');
        }

        function updateFacultyChart() {
            if (!facultyChart || !facultyData.distribution.length) return;

            facultyChart.data.datasets[0].data = facultyData.distribution.map(d => d['Strongly Agree'] || 0);
            facultyChart.data.datasets[1].data = facultyData.distribution.map(d => d['Agree'] || 0);
            facultyChart.data.datasets[2].data = facultyData.distribution.map(d => d['Disagree'] || 0);
            facultyChart.data.datasets[3].data = facultyData.distribution.map(d => d['Strongly Disagree'] || 0);
            facultyChart.update('none');
        }

        // Calculate satisfaction score from distribution
        function calculateSatisfactionScore(distribution) {
            if (!distribution || distribution.length === 0) return 0;

            let totalPositive = 0;
            let totalResponses = 0;

            distribution.forEach(q => {
                const sa = q['Strongly Agree'] || 0;
                const a = q['Agree'] || 0;
                const d = q['Disagree'] || 0;
                const sd = q['Strongly Disagree'] || 0;
                const total = sa + a + d + sd;

                if (total > 0) {
                    // Weight: SA=100, A=75, D=25, SD=0
                    const score = (sa * 100 + a * 75 + d * 25 + sd * 0) / total;
                    totalPositive += score;
                    totalResponses++;
                }
            });

            return totalResponses > 0 ? Math.round(totalPositive / totalResponses) : 0;
        }

        // Update satisfaction score display
        function updateSatisfactionDisplay(type, distribution) {
            const score = calculateSatisfactionScore(distribution);
            const circleEl = document.getElementById(`${type}ScoreCircle`);
            const descEl = document.getElementById(`${type}ScoreDesc`);

            if (!circleEl || !descEl) return;

            circleEl.textContent = score;

            // Update circle color based on score
            circleEl.classList.remove('high', 'medium', 'low');
            if (score >= 70) {
                circleEl.classList.add('high');
                descEl.textContent = 'Excellent - Strong positive sentiment';
            } else if (score >= 50) {
                circleEl.classList.add('medium');
                descEl.textContent = 'Moderate - Some areas of strength and areas for improvement';
            } else {
                circleEl.classList.add('low');
                descEl.textContent = 'Needs attention - Address concerns';
            }
        }

        // Trigger confetti celebration
        let familyConfettiShown = false;
        let facultyConfettiShown = false;

        function triggerConfetti(type) {
            if (type === 'family' && familyConfettiShown) return;
            if (type === 'faculty' && facultyConfettiShown) return;

            // Fire confetti
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const colors = ['#D4A012', '#F5C842', '#0D9488', '#2DD4BF', '#FFFFFF'];

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.7 },
                    colors: colors
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.7 },
                    colors: colors
                });

                if (Date.now() < animationEnd) {
                    requestAnimationFrame(frame);
                }
            }());

            if (type === 'family') familyConfettiShown = true;
            if (type === 'faculty') facultyConfettiShown = true;
        }

        // Detect areas of concern (questions below 60% positive)
        function detectConcerns(distribution, questionsFull) {
            const concerns = [];

            distribution.forEach((q, i) => {
                const total = q['Strongly Agree'] + q['Agree'] + q['Disagree'] + q['Strongly Disagree'];
                if (total === 0) return;

                const positivePercent = ((q['Strongly Agree'] + q['Agree']) / total) * 100;

                if (positivePercent < 60) {
                    concerns.push({
                        question: questionsFull[i],
                        percent: Math.round(positivePercent)
                    });
                }
            });

            return concerns.sort((a, b) => a.percent - b.percent);
        }

        // Update concern alerts display
        function updateConcernAlerts(type, distribution, questionsFull) {
            const container = document.getElementById(`${type}ConcernAlerts`);
            if (!container) return;

            const concerns = detectConcerns(distribution, questionsFull);

            if (concerns.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = concerns.slice(0, 3).map(c => `
                <div class="concern-alert">
                    <svg class="concern-alert-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <div class="concern-alert-content">
                        <div class="concern-alert-title">Needs Attention (${c.percent}% positive)</div>
                        <div class="concern-alert-text">${c.question}</div>
                    </div>
                </div>
            `).join('');
        }

        // Create timeline chart for response history
        function createFacultyTimelineChart() {
            const ctx = document.getElementById('facultyTimelineChart');
            if (!ctx) return;

            facultyTimelineChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cumulative Responses',
                        data: [],
                        borderColor: '#D4A012',
                        backgroundColor: 'rgba(212, 160, 18, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#D4A012',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#012141',
                            titleFont: { family: 'DM Sans', size: 11 },
                            bodyFont: { family: 'DM Sans', size: 10 },
                            padding: 10,
                            cornerRadius: 8,
                            borderColor: '#D4A012',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { family: 'DM Sans', size: 9 },
                                color: '#012141',
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#E8DFC9' },
                            ticks: {
                                font: { family: 'DM Sans', size: 9 },
                                color: '#012141',
                                stepSize: 5
                            }
                        }
                    }
                }
            });
        }

        // Update timeline chart with response data
        function updateFacultyTimelineChart(responses) {
            if (!facultyTimelineChart) {
                createFacultyTimelineChart();
            }
            if (!facultyTimelineChart || !responses.length) return;

            // Group responses by date
            const dateMap = {};
            responses.forEach(resp => {
                if (resp.submitted_at) {
                    const date = new Date(resp.submitted_at);
                    const dateKey = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    dateMap[dateKey] = (dateMap[dateKey] || 0) + 1;
                }
            });

            // Sort dates and calculate cumulative
            const sortedDates = Object.keys(dateMap).sort((a, b) => {
                return new Date(a + ', 2025') - new Date(b + ', 2025');
            });

            let cumulative = 0;
            const cumulativeData = sortedDates.map(date => {
                cumulative += dateMap[date];
                return cumulative;
            });

            // Update chart
            facultyTimelineChart.data.labels = sortedDates;
            facultyTimelineChart.data.datasets[0].data = cumulativeData;
            facultyTimelineChart.update('none');
        }

        // Fetch Family Survey data
        async function fetchFamilyData() {
            try {
                const response = await fetch(CONFIG.familyCSVUrl);
                const csv = await response.text();
                const { headers, data } = parseCSV(csv);

                const count = data.length;
                const percent = Math.min(100, Math.round((count / CONFIG.familyGoal) * 100));

                // Update home view
                document.getElementById('familyCount').textContent = count.toLocaleString();
                document.getElementById('familyRate').textContent = `${percent}%`;
                document.getElementById('familyPercent').textContent = `${percent}%`;
                document.getElementById('familyProgress').style.width = `${Math.min(100, percent)}%`;
                document.getElementById('familyGoalText').textContent = count.toLocaleString();

                const badge = document.getElementById('familyBadge');
                if (count >= CONFIG.familyGoal) {
                    badge.textContent = 'Goal Met!';
                    badge.className = 'card-badge goal-met';
                    triggerConfetti('family');
                } else {
                    badge.textContent = 'In Progress';
                    badge.className = 'card-badge in-progress';
                }

                // Update detail view
                document.getElementById('familyDetailCount').textContent = count.toLocaleString();
                document.getElementById('familyDetailPercent').textContent = `${percent}%`;

                // Separate Likert headers from free response headers
                const likertHeaders = headers.filter(h => !h.toLowerCase().includes('free') && !h.toLowerCase().includes('response') && !h.toLowerCase().includes('comment') && !h.toLowerCase().includes('feedback'));
                const freeResponseHeaders = headers.filter(h => h.toLowerCase().includes('free') || h.toLowerCase().includes('response') || h.toLowerCase().includes('comment') || h.toLowerCase().includes('feedback'));

                // Store distribution and update chart (only for Likert questions)
                familyData.distribution = analyzeResponses(data, likertHeaders);
                familyData.count = count;

                // Extract free responses
                const feedback = [];
                data.forEach(row => {
                    freeResponseHeaders.forEach(header => {
                        if (row[header] && row[header].trim()) {
                            feedback.push({ text: row[header].trim() });
                        }
                    });
                    // Also check for "Free_Response" column specifically
                    if (row['Free_Response'] && row['Free_Response'].trim()) {
                        if (!feedback.find(f => f.text === row['Free_Response'].trim())) {
                            feedback.push({ text: row['Free_Response'].trim() });
                        }
                    }
                });
                familyData.feedback = feedback;

                updateFamilyChart();

                // Update insights
                if (count > 0) {
                    const insights = calculateInsights(familyData.distribution, FAMILY_QUESTIONS_FULL);
                    document.getElementById('familyStrongest').textContent = insights.strongest;
                    document.getElementById('familyStrongestValue').textContent = insights.strongestValue;
                    document.getElementById('familyWeakest').textContent = insights.weakest;
                    document.getElementById('familyWeakestValue').textContent = insights.weakestValue;
                    document.getElementById('familySentiment').textContent = insights.sentiment;
                    document.getElementById('familySentimentValue').textContent = insights.sentimentValue;

                    // Update satisfaction score
                    updateSatisfactionDisplay('family', familyData.distribution);

                    // Update concern alerts
                    updateConcernAlerts('family', familyData.distribution, FAMILY_QUESTIONS_FULL);
                }

                // Update feedback section
                const feedbackContainer = document.getElementById('familyFeedback');
                if (feedbackContainer && feedback.length > 0) {
                    feedbackContainer.innerHTML = feedback.slice(0, 5).map(f => `
                        <div class="feedback-item positive">
                            <div class="feedback-text">"${f.text}"</div>
                            <div class="feedback-type">Family feedback</div>
                        </div>
                    `).join('');
                } else if (feedbackContainer) {
                    feedbackContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">No feedback submitted yet.</p>';
                }

            } catch (error) {
                console.error('Error fetching family data:', error);
            }
        }

        // Fetch Faculty Survey data from Typeform
        async function fetchFacultyData() {
            try {
                const response = await fetch('/api/typeform');
                const data = await response.json();
                const responses = data.items || [];
                const count = responses.length;
                const percent = Math.min(100, Math.round((count / CONFIG.facultyGoal) * 100));

                // Update home view
                document.getElementById('facultyCount').textContent = count.toLocaleString();
                document.getElementById('facultyRate').textContent = `${percent}%`;
                document.getElementById('facultyPercent').textContent = `${percent}%`;
                document.getElementById('facultyProgress').style.width = `${Math.min(100, percent)}%`;
                document.getElementById('facultyGoalText').textContent = count.toLocaleString();

                const badge = document.getElementById('facultyBadge');
                if (count >= CONFIG.facultyGoal) {
                    badge.textContent = 'Goal Met!';
                    badge.className = 'card-badge goal-met';
                    triggerConfetti('faculty');
                } else {
                    badge.textContent = 'In Progress';
                    badge.className = 'card-badge in-progress';
                }

                // Update detail view
                document.getElementById('facultyDetailCount').textContent = count.toLocaleString();
                document.getElementById('facultyDetailPercent').textContent = `${percent}%`;

                // Analyze Typeform responses
                const distribution = FACULTY_QUESTIONS.map(() => ({
                    'Strongly Agree': 0,
                    'Agree': 0,
                    'Disagree': 0,
                    'Strongly Disagree': 0
                }));

                const questionFieldIds = [
                    'q4QdVXMAes63',
                    'k3BbbaohVfkp',
                    'b5DFCh8LrRgk',
                    'Q5h9fIVf2ShA',
                    'tAVh4ZMZJn66'
                ];

                const feedbackFieldIds = {
                    positive: '8YZikKxFBzDV',
                    concerns: 'oURZDVN67s4b'
                };

                const feedback = [];

                responses.forEach(resp => {
                    if (resp.answers) {
                        resp.answers.forEach(answer => {
                            const qIndex = questionFieldIds.indexOf(answer.field?.id);
                            if (qIndex !== -1 && answer.choice?.label) {
                                // Normalize label: "Strongly agree" -> "Strongly Agree"
                                const rawLabel = answer.choice.label;
                                const label = rawLabel.split(' ').map(word =>
                                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                ).join(' ');
                                if (distribution[qIndex][label] !== undefined) {
                                    distribution[qIndex][label]++;
                                }
                            }

                            if (answer.field?.id === feedbackFieldIds.positive && answer.text) {
                                feedback.push({ type: 'positive', text: answer.text });
                            }
                            if (answer.field?.id === feedbackFieldIds.concerns && answer.text) {
                                feedback.push({ type: 'concern', text: answer.text });
                            }
                        });
                    }
                });

                facultyData.distribution = distribution;
                facultyData.count = count;
                facultyData.feedback = feedback;
                facultyData.timeline = responses;
                updateFacultyChart();
                updateFacultyTimelineChart(responses);

                // Update insights
                if (count > 0) {
                    const insights = calculateInsights(distribution, FACULTY_QUESTIONS_FULL);
                    document.getElementById('facultyStrongest').textContent = insights.strongest;
                    document.getElementById('facultyStrongestValue').textContent = insights.strongestValue;
                    document.getElementById('facultyWeakest').textContent = insights.weakest;
                    document.getElementById('facultyWeakestValue').textContent = insights.weakestValue;

                    // Update satisfaction score
                    updateSatisfactionDisplay('faculty', distribution);

                    // Update concern alerts
                    updateConcernAlerts('faculty', distribution, FACULTY_QUESTIONS_FULL);
                }

                // Update feedback section
                const feedbackContainer = document.getElementById('facultyFeedback');
                feedbackContainer.innerHTML = feedback.slice(0, 4).map(f => `
                    <div class="feedback-item ${f.type}">
                        <div class="feedback-text">"${f.text}"</div>
                        <div class="feedback-type">${f.type === 'positive' ? 'Positive feedback' : 'Suggestion/Concern'}</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error fetching faculty data:', error);
            }
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('lastUpdated').textContent = `Updated ${time}`;
        }

        // Initialize
        async function init() {
            await Promise.all([fetchFamilyData(), fetchFacultyData()]);
            updateTimestamp();
        }

        // Auto-refresh
        setInterval(init, CONFIG.refreshInterval);

        // Initial load
        init();
    </script>
</body>
</html>
